<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据看板 - 老王股票分析系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
        }
        .card {
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            border: 1px solid rgba(0, 0, 0, 0.125);
        }
        .header-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .stat-card {
            text-align: center;
            padding: 20px;
        }
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #007bff;
        }
        .positive {
            color: green;
        }
        .negative {
            color: red;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg header-bg">
        <div class="container">
            <a class="navbar-brand text-white" href="/">← 返回首页</a>
            <span class="navbar-text text-white">数据看板</span>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">市场概览</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 col-6 mb-3">
                                <div class="stat-card">
                                    <div class="stat-number" id="shanghaiIndex">-</div>
                                    <div>上证指数</div>
                                </div>
                            </div>
                            <div class="col-md-3 col-6 mb-3">
                                <div class="stat-card">
                                    <div class="stat-number" id="shenzhenIndex">-</div>
                                    <div>深证成指</div>
                                </div>
                            </div>
                            <div class="col-md-3 col-6 mb-3">
                                <div class="stat-card">
                                    <div class="stat-number" id="growthIndex">-</div>
                                    <div>创业板指</div>
                                </div>
                            </div>
                            <div class="col-md-3 col-6 mb-3">
                                <div class="stat-card">
                                    <div class="stat-number" id="totalAlerts">-</div>
                                    <div>今日警报</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- 股票图表区域 -->
            <div class="col-md-8">
                <div class="card mb-4">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">股票走势图</h5>
                        <select class="form-select form-select-sm w-auto" id="dashboardStockSelect">
                            <option value="">选择股票</option>
                            <!-- 动态填充 -->
                        </select>
                    </div>
                    <div class="card-body">
                        <canvas id="dashboardChart" height="400"></canvas>
                    </div>
                </div>
            </div>

            <!-- 警报和分析区域 -->
            <div class="col-md-4">
                <div class="card mb-4">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">最新警报</h5>
                    </div>
                    <div class="card-body p-0">
                        <ul class="list-group list-group-flush" id="recentAlerts">
                            <li class="list-group-item text-center text-muted">加载中...</li>
                        </ul>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">AI分析摘要</h5>
                    </div>
                    <div class="card-body" id="aiAnalysisSummary">
                        <p class="text-muted text-center">点击下方按钮获取最新AI分析</p>
                        <button class="btn btn-info w-100" id="getAiSummaryBtn">获取AI分析摘要</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let dashboardChart = null;
        let watchlist = [];

        // DOM加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadWatchlist();
            loadMarketOverview();
            loadRecentAlerts();
            setupEventListeners();
        });

        // 设置事件监听器
        function setupEventListeners() {
            document.getElementById('dashboardStockSelect').addEventListener('change', function() {
                const symbol = this.value;
                if (symbol) {
                    loadDashboardChartData(symbol);
                }
            });

            document.getElementById('getAiSummaryBtn').addEventListener('click', function() {
                getAiAnalysisSummary();
            });
        }

        // 加载监控列表
        function loadWatchlist() {
            fetch('/api/watchlist')
                .then(response => response.json())
                .then(data => {
                    watchlist = data;
                    updateStockSelectOptions();
                })
                .catch(error => console.error('Error loading watchlist:', error));
        }

        // 更新股票选择选项
        function updateStockSelectOptions() {
            const select = document.getElementById('dashboardStockSelect');
            select.innerHTML = '<option value="">选择股票</option>';
            
            watchlist.forEach(symbol => {
                const option = document.createElement('option');
                option.value = symbol;
                option.textContent = symbol;
                select.appendChild(option);
            });
        }

        // 加载市场概览
        function loadMarketOverview() {
            // 这里应该从API获取市场概览数据
            // 模拟数据，实际应该从后端API获取
            document.getElementById('shanghaiIndex').textContent = '3,050.12';
            document.getElementById('shanghaiIndex').className = 'stat-number positive';
            
            document.getElementById('shenzhenIndex').textContent = '10,215.68';
            document.getElementById('shenzhenIndex').className = 'stat-number negative';
            
            document.getElementById('growthIndex').textContent = '2,089.34';
            document.getElementById('growthIndex').className = 'stat-number positive';
            
            document.getElementById('totalAlerts').textContent = '5';
        }

        // 加载最近警报
        function loadRecentAlerts() {
            fetch('/api/alerts')
                .then(response => response.json())
                .then(alerts => {
                    const container = document.getElementById('recentAlerts');
                    container.innerHTML = '';
                    
                    if (alerts.length === 0) {
                        container.innerHTML = '<li class="list-group-item text-center text-muted">暂无警报</li>';
                        return;
                    }
                    
                    // 只显示最新的5个警报
                    const recentAlerts = alerts.slice(-5).reverse();
                    
                    recentAlerts.forEach(alert => {
                        const li = document.createElement('li');
                        li.className = 'list-group-item';
                        
                        let severityClass = '';
                        switch(alert.severity) {
                            case 'high':
                                severityClass = 'text-danger';
                                break;
                            case 'medium':
                                severityClass = 'text-warning';
                                break;
                            case 'low':
                                severityClass = 'text-info';
                                break;
                            default:
                                severityClass = 'text-secondary';
                        }
                        
                        li.innerHTML = `
                            <div class="d-flex justify-content-between">
                                <span class="${severityClass}">
                                    <strong>${alert.type}</strong>: ${alert.message}
                                </span>
                                <small class="text-muted">${new Date(alert.timestamp).toLocaleTimeString()}</small>
                            </div>
                            <small class="text-muted">${alert.symbol}</small>
                        `;
                        
                        container.appendChild(li);
                    });
                })
                .catch(error => {
                    console.error('Error loading alerts:', error);
                    const container = document.getElementById('recentAlerts');
                    container.innerHTML = '<li class="list-group-item text-center text-danger">加载警报失败</li>';
                });
        }

        // 初始化仪表板图表
        function initDashboardChart() {
            const ctx = document.getElementById('dashboardChart').getContext('2d');
            
            if (dashboardChart) {
                dashboardChart.destroy();
            }
            
            dashboardChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: '收盘价',
                        data: [],
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1,
                        fill: false
                    }, {
                        label: '开盘价',
                        data: [],
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        tension: 0.1,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    }
                }
            });
        }

        // 加载仪表板图表数据
        function loadDashboardChartData(symbol) {
            if (!symbol) return;
            
            fetch(`/api/stock/${symbol}/data`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('获取股票数据失败: ' + data.error);
                        return;
                    }
                    
                    if (!dashboardChart) {
                        initDashboardChart();
                    }
                    
                    // 更新图表数据
                    dashboardChart.data.labels = data.dates;
                    dashboardChart.data.datasets[0].data = data.close;
                    dashboardChart.data.datasets[1].data = data.open;
                    dashboardChart.update();
                })
                .catch(error => {
                    console.error('Error loading chart data:', error);
                    alert('加载图表数据失败');
                });
        }

        // 获取AI分析摘要
        function getAiAnalysisSummary() {
            const summaryDiv = document.getElementById('aiAnalysisSummary');
            summaryDiv.innerHTML = '<p class="text-info text-center">正在获取AI分析摘要...</p>';
            
            // 这里应该是获取整个监控列表的AI分析摘要
            // 由于API限制，这里暂时显示模拟数据
            setTimeout(() => {
                summaryDiv.innerHTML = `
                    <h6>市场分析摘要</h6>
                    <p><strong>趋势判断:</strong> 市场整体呈现震荡态势，建议关注政策面变化</p>
                    <p><strong>重点关注:</strong> 科技板块和新能源赛道短期波动较大</p>
                    <p><strong>风险提示:</strong> 美联储政策预期变化可能影响市场情绪</p>
                    <p><strong>操作建议:</strong> 控制仓位，关注结构性机会</p>
                    <button class="btn btn-info w-100 mt-2" onclick="getAiAnalysisSummary()">刷新分析</button>
                `;
            }, 1000);
        }

        // 定期刷新数据
        setInterval(function() {
            loadRecentAlerts();
        }, 30000); // 每30秒刷新一次警报
    </script>
</body>
</html>